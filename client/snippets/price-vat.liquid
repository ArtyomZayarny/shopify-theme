{%- comment -%}
  Renders VAT price breakdown below the main price.
  Accepts:
  - product: {Object} Product Liquid object (for metafield check)
  - price: {Number} Price in cents (e.g. variant.price)
  - compare_at_price: {Number} Optional, original price before discount (in cents)

  Usage:
  {%- render 'price-vat', product: product, price: variant.price, compare_at_price: variant.compare_at_price -%}
{%- endcomment -%}

{%- if settings.vat_enabled and product.metafields.custom.show_tax.value == true -%}
  {%- assign vat_rate = settings.vat_rate -%}
  {%- assign on_sale = false -%}
  {%- if compare_at_price and compare_at_price > price -%}
    {%- assign on_sale = true -%}
  {%- endif -%}

  {%- if settings.vat_prices_include_tax -%}
    {%- comment -%} Prices include tax: excl = price * 100 / (100 + rate) {%- endcomment -%}
    {%- assign divisor = 100 | plus: vat_rate -%}
    {%- assign incl_price = price -%}
    {%- assign excl_price = price | times: 100 | divided_by: divisor -%}
    {%- if on_sale -%}
      {%- assign compare_incl = compare_at_price -%}
      {%- assign compare_excl = compare_at_price | times: 100 | divided_by: divisor -%}
    {%- endif -%}
  {%- else -%}
    {%- comment -%} Prices exclude tax: incl = price * (100 + rate) / 100 {%- endcomment -%}
    {%- assign multiplier = 100 | plus: vat_rate -%}
    {%- assign excl_price = price -%}
    {%- assign incl_price = price | times: multiplier | divided_by: 100 -%}
    {%- if on_sale -%}
      {%- assign compare_excl = compare_at_price -%}
      {%- assign compare_incl = compare_at_price | times: multiplier | divided_by: 100 -%}
    {%- endif -%}
  {%- endif -%}

  <div class="price-vat{% if on_sale %} price-vat--sale{% endif %}">
    <span class="price-vat__line">
      <span class="price-vat__label">Incl. VAT:</span>
      {%- if on_sale -%}
        <s class="price-vat__compare">{{ compare_incl | money }}</s>
      {%- endif -%}
      {{ incl_price | money }}
    </span>
    <span class="price-vat__line">
      <span class="price-vat__label">Excl. VAT:</span>
      {%- if on_sale -%}
        <s class="price-vat__compare">{{ compare_excl | money }}</s>
      {%- endif -%}
      {{ excl_price | money }}
    </span>
  </div>
{%- endif -%}
